<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Freebox Monitoring</title>
<style type="text/css">
<!--
.Style1 {
	font-family: Geneva, Arial, Helvetica, sans-serif;
	font-size: 24px;
	font-weight: bold;
	color: #FF9900;
}
.Style2 {
	font-family: Geneva, Arial, Helvetica, sans-serif;
	font-weight: bold;
}
.Style3 {
	font-family: Arial, Helvetica, sans-serif;
	font-size: 14px;
}
.Style4 {
	font-family: "Courier New", Courier, monospace;
	font-size: small;
}
.Style5 {
	font-family: Arial, Helvetica, sans-serif;
	font-size: 14px;
	color: #0066FF;
	font-weight: bold;
}
.Style6 {
	color: #FF0000;
	font-weight: bold;
}
.Style7 {font-family: "Courier New", Courier, monospace; font-size: small; font-weight: bold; }
.Style8 {color: #993399}
.Style10 {color: #993399; font-family: "Courier New", Courier, monospace; }
-->
</style>
</head>

<body>
<p class="Style1">Monitoring d'une Freebox Révolution</p>
<p class="Style2">Le but de ce Tuto :</p>
<p class="Style3">Il s'agit ici de présenter un tuto pour monitorer sa Freebox, avec les outils telegraf / influxdb / grafana, en complément de ce  Tuto général [TUTO] Monitoring NAS et Réseau qui reste la référence.<br />
  En conséquence, je suppose déjà opérationnelle une chaine complète telegraf / influxdb / grafana pour la supervision de votre NAS.<br />
  Il faudra bien entendu faire les adaptations spécifiques à votre environnement.<br />
  Principe : Le docker telegraf va utiliser un script python pour récupérer les infos de la Freebox. Il y a quelques semaines, je ne connaissait pas python ... . donc il y a surement des façons plus élégantes de programmer, merci de votre indulgence.</p>
<p class="Style2">Limites :</p>
<p class="Style3"> je n'ai pu valider cette méthode que sur ma Freebox, et donc pour les autres modèles et/ou configuration ... ?<br />
  Freebox Révolution au dernier Firmware (4.0.7) à ce jour.<br />
  Accès réseau fibre ftth (et donc pas testé les compteurs xDSL)</p>
<p><span class="Style2">Sources : </span></p>
<blockquote>
  <p><a href="https://www.nas-forum.com/forum/topic/63273-tuto-monitoring-nas-et-réseau/?tab=comments#comment-1319376875">https://www.nas-forum.com/forum/topic/63273-tuto-monitoring-nas-et-réseau/?tab=comments#comment-1319376875</a><br />
  	<a href="https://github.com/tsugliani/freebox-revolution-monitoring">https://github.com/tsugliani/freebox-revolution-monitoring </a><br />
    <a href="https://gikspirit.com/comment-installer-python-3-7-sur-ubuntu-18-04/">https://gikspirit.com/comment-installer-python-3-7-sur-ubuntu-18-04/</a><br />
    <a href="https://docs.python.org/fr/3/installing/index.html">https://docs.python.org/fr/3/installing/index.html</a><br />
    <a href="https://github.com/influxdata/telegraf/blob/master/docs/DATA_FORMATS_INPUT.md">https://github.com/influxdata/telegraf/blob/master/docs/DATA_FORMATS_INPUT.md</a><br />
    <a href="https://dev.freebox.fr/sdk/os">https://dev.freebox.fr/sdk/os</a><br />
    <a href="https://github.com/influxdata/telegraf/issues">https://github.com/influxdata/telegraf/issues</a><br />
    <a href="http://sametmax.com/lencoding-en-python-une-bonne-fois-pour-toute/">http://sametmax.com/lencoding-en-python-une-bonne-fois-pour-toute/</a><br />
    <a href="https://github.com/influxdata/telegraf/blob/master/README.md">https://github.com/influxdata/telegraf/blob/master/README.md</a><br />
    <a href="https://docs.influxdata.com/influxdb/v1.7/query_language/spec/">https://docs.influxdata.com/influxdb/v1.7/query_language/spec/</a><br />
  <a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.2/query-dsl-regexp-query.html#regexp-syntax">https://www.elastic.co/guide/en/elasticsearch/reference/6.2/query-dsl-regexp-query.html#regexp-syntax</a></p>
</blockquote>
<p class="Style2">Chaine existante (hypothèse) :</p>
<p class="Style3"> je suppose donc que vous avez une chaine telegraf / influxdb / grafana opérationnelle pour votre NAS, en docker mode bridge.</p>
<p align="center" class="Style3"><img src="docker tig 1.PNG" width="900" height="216" /><br />
</p>
<p class="Style2">Ajout Freebox :</p>
<p class="Style3"> On va rajouter un second docker telegraf, qui portera le script Pyhton. Ce docker telegraf dédié Freebox va transmettre ses données vers une seconde database que l'on va créer dans le docker Influx<br />
Sur grafana, on créera une nouvelle source de données (la nouvelle database d'influx) qui nous permettra d'afficher les données Freebox</p>
<p align="center" class="Style3"><img src="Pres Tuto Fbox Monitoring.png" width="1215" height="662" /><br />
</p>
<p class="Style2">Configuration des dockers existants :</p>
<table width="30%" border="1" cellspacing="2" bordercolor="#003366">
  <tr>
    <td width="50%">subnet</td>
    <td width="50%">172.20.0.0/29</td>
  </tr>
  <tr>
    <td>gateway</td>
    <td>172.20.0.1</td>
  </tr>
  <tr>
    <td>ip_range</td>
    <td>172.20.0.0/29</td>
  </tr>
</table>
<p class="Style2"> Adressage    </p>
<table width="45%" border="1" cellspacing="2" bordercolor="#000066">
  <tr>
    <td width="33%">grafana</td>
    <td width="34%">d2:ca:ab:cd:00:02</td>
    <td width="33%">172.20.0.2</td>
  </tr>
  <tr>
    <td>influxdb</td>
    <td>d2:ca:ab:cd:00:03</td>
    <td>172.20.0.3</td>
  </tr>
  <tr>
    <td>nas_telegraf</td>
    <td>d2:ca:ab:cd:00:04</td>
    <td>172.20.0.4</td>
  </tr>
</table>
<p><span class="Style2">Creation du nouveau docker : fbx_telegraf</span><br />
</p>
<p class="Style3">Adressage sur le réseau bridge : </p>
<table width="45%" border="1" cellspacing="2" bordercolor="#000099">
  <tr>
    <td width="33%">fbx_telegraf</td>
    <td width="33%">d2:ca:ab:cd:00:05</td>
    <td width="34%">172.20.0.5</td>
  </tr>
</table>
<p class="Style5">Déclaration du service fbx_telegraf dans le docker-compose.yaml (extrait): </p>
<blockquote>  
  <pre class="Style4">services:
     fbx_telegraf:
     	image: telegraf:latest
     	container_name: fbx_telegraf
     	hostname: fbx_telegraf mac_address: d2:ca:ab:cd:00:05
     	networks:
     		monitoring:
     			ipv4_address: 172.20.0.5
     	environment:
     		- PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/bin:/sbin:/usr/local:/usr/src
     		- TZ=CET
     	mem_limit: 75M 
     	volumes:
     		- &quot;/volume1/docker/monitoring/fbx_telegraf/telegraf.conf:/etc/telegraf/telegraf.conf:ro&quot;

     		# pour le fichier de commande python, 
     		# pour le fichier get-pip.py (install module pip puis requests)
     		- &quot;/volume1/docker/monitoring/fbx_telegraf/py:/usr/local/py:ro&quot; 
     		# pour le fichier log si on le met en place
     		- &quot;/volume1/docker/monitoring/fbx_telegraf/log:/usr/local/log&quot;
     	ports:
     		- 9125:8125/udp
     		- 9092:8092/udp
     		- 9094:8094
     	restart: unless-stopped</pre>
</blockquote>
<p class="Style3">On notera la creation et le mapping de 2 repertoires : </p>
<ul>
  <li class="Style3"> un repertoire pour le fichier Python et le fichier d'installation de l'utilitaire python &quot;pip&quot; : /usr/local/py</li>
  <li class="Style3">    un repertoire pour d'eventuels logs : /usr/local/log</li>
</ul>
<p><span class="Style5">Création et demarrage du docker fbx_telegraf:</span></p>
<blockquote>
  <p><span class="Style3">En ssh sur le NAS : </span><br />
  </p>
  <blockquote>
    <p class="Style7">docker-compose pull fbx_telegraf<br />
      docker-compose up -d fbx_telegraf</p>
  </blockquote>
</blockquote>
<p align="center" class="Style7"><img src="docker tig fbx 1.PNG" width="900" height="269" /></p>
<p align="center" class="Style7"><img src="docker tig fbx 2.PNG" width="900" height="288" /></p>
<p><span class="Style5">Via un acces ssh sur le NAS : mise à jour du docker fbx_telegraf</span></p>
<blockquote>
  <p>En ssh sur le NAS :<br />
  </p>
  <blockquote>
    <p><span class="Style7">docker exec -it fbx_telegraf apt update<br />
      docker exec -it fbx_telegraf apt upgrade<br />
      docker exec -it fbx_telegraf apt install -y software-properties-common</span></p>
  </blockquote>
</blockquote>
<p class="Style5">Installaltion des modules pip et requests</p>
<blockquote>
  <p class="Style3">En ssh sur le NAS : </p>
  <blockquote>
    <p class="Style7"> docker exec -it fbx_telegraf wget https://bootstrap.pypa.io/get-pip.py<br />
      docker exec -it fbx_telegraf python3 get-pip.py --prefix=/usr/local<br />
      docker exec -it fbx_telegraf python3 -m pip install requests</p>
  </blockquote>
</blockquote>
<p><span class="Style5">Script Python :</span></p>
<blockquote>
  <p>  <span class="Style3">On place le script Python</span> <span class="Style4">fbx_telegraf_050.py</span> <span class="Style3">dans le repertoire </span><span class="Style4">/usr/local/py</span><br />
    <span class="Style3">(ce script a été mis à jour pour mes propres besoins. N'hesitez pas à le reprendre, en particulier en fonction de l'API Freebox si il vous manque des éléments)</span></p>
</blockquote>
<p><span class="Style5">Modification du fichier de configuration telegraf : </span><br />
  <br />
  <span class="Style3">- Dans la section &quot;Input Plugin&quot; :</span></p>
<blockquote>
  <p><br />
    <span class="Style4">###############################################################################<br />
    #                            INPUT PLUGINS                                    #<br />
    ###############################################################################<br />
    <br />
    ###############################################################################<br />
    #                            INPUT PLUGINS FREEBOX                            #<br />
    ###############################################################################<br />
    <br />
    # Read metrics from one or more commands that can output to stdout<br />
    [[inputs.exec]]<br />
    ## Commands array<br />
    #<br />
    <strong>commands = [<br />
&quot;python3 /usr/local/py/freebox_050.py -SPHDIWX&quot;<br />
    ]</strong><br />
    <br />
    ## Timeout for each command to complete.<br />
    <strong>timeout = &quot;5s&quot;</strong><br />
    <br />
    ## Data format to consume.<br />
    ## Each data format has it's own unique set of configuration options, read<br />
    ## more about them here:<br />
    ## https://github.com/influxdata/telegraf/blob/master/docs/DATA_FORMATS_INPUT.md<br />
    # data_format = &quot;graphite&quot;<br />
    <strong>data_format = &quot;influx&quot;</strong></span></p>
</blockquote>
<p class="Style3">- Dans la section &quot;Output Plugins&quot; : </p>
<blockquote>
  <p class="Style3"> On va envoyer nos données vers une base de données de nom de <span class="Style4">fbx_database</span>, user <span class="Style4">fbx_databse</span>, password <span class="Style4">fbx_database</span><br />
    De plus, on va créer nous même cette database =&gt; <span class="Style4">skip_database_creation = true</span></p>
  <blockquote>
    <p class="Style4"> ###############################################################################<br />
      #                            OUTPUT PLUGINS                                   #<br />
      ###############################################################################<br />
      <br />
      <br />
      # Configuration for sending metrics to InfluxDB<br />
      [[outputs.influxdb]]<br />
      ## The full HTTP or UDP URL for your InfluxDB instance.<br />
      ##<br />
      ## Multiple URLs can be specified for a single cluster, only ONE of the<br />
      ## urls will be written to each interval.<br />
      # urls = [&quot;unix:///var/run/influxdb.sock&quot;]<br />
      # urls = [&quot;udp://127.0.0.1:8089&quot;]<br />
      <strong>urls = [&quot;http://influxdb:8086&quot;]</strong><br />
      <br />
      ## The target database for metrics; will be created as needed.<br />
      ## For UDP url endpoint database needs to be configured on server side.<br />
      <strong>database = &quot;fbx_telegraf&quot;</strong><br />
      <br />
      ## The value of this tag will be used to determine the database.  If this<br />
      ## tag is not set the 'database' option is used as the default.<br />
      <strong>database_tag = &quot;&quot;</strong><br />
      <br />
      ## If true, the database tag will not be added to the metric.<br />
      # exclude_database_tag = false<br />
      <br />
      ## If true, no CREATE DATABASE queries will be sent.  Set to true when using<br />
      ## Telegraf with a user without permissions to create databases or when the<br />
      ## database already exists.<br />
      <strong>skip_database_creation = true</strong><br />
      <br />
      ## Name of existing retention policy to write to.  Empty string writes to<br />
      ## the default retention policy.  Only takes effect when using HTTP.<br />
      <strong>retention_policy = &quot;&quot;</strong><br />
      <br />
      ## Write consistency (clusters only), can be: &quot;any&quot;, &quot;one&quot;, &quot;quorum&quot;, &quot;all&quot;.<br />
      ## Only takes effect when using HTTP.<br />
      <strong>write_consistency = &quot;any&quot;</strong><br />
      <br />
      ## Timeout for HTTP messages.<br />
      <strong>timeout = &quot;30s&quot;</strong><br />
      <br />
      ## HTTP Basic Auth<br />
      <strong>username = &quot;fbx_telegraf&quot;<br />
      password = &quot;fbx_telegraf&quot;</strong><br />
      <br />
      ## HTTP User-Agent<br />
      # user_agent = &quot;telegraf&quot;</p>
  </blockquote>
  <p class="Style3"> On redemarre le docker fbx_telegraf.</p>
</blockquote>
<p class="Style5">Creation de la database fbx_telegraf sur influxdb</p>
<blockquote>
  <p class="Style3"> Se connecter en console sur le docker influxdb, puis créer la database : </p>
  <blockquote>
    <p class="Style4">    root@influxdb:/# <strong>influx -username admin -password admin</strong> <br />
      Connected to http://localhost:8086 version 1.7.9 <br />
      InfluxDB shell version: 1.7.9<br />
  &gt; <strong>show databases</strong> <br />
      <span class="Style8">name: databases <br />
      name <br />
      ---- <br />
      _internal <br />
      nas_telegraf</span> <br />
  &gt; <strong>create database fbx_telegraf</strong> <br />
  &gt; <strong>use fbx_telegraf </strong><br />
      <span class="Style8">Using database fbx_telegraf</span> <br />
  &gt; <strong>create user fbx_telegraf with password 'fbx_telegraf'</strong> <br />
  &gt; <strong>grant all on fbx_telegraf to fbx_telegraf </strong><br />
  &gt;<br />
  &gt; <strong>show databases</strong> <br />
      <span class="Style8">name: databases <br />
      name <br />
      ---- <br />
      _internal <br />
      nas_telegraf <br />
      fbx_telegraf</span> <br />
  &gt; <strong>show users </strong><br />
      <span class="Style8">user         admin <br />
      ----         ----- <br />
      admin        true <br />
      nas_telegraf false <br />
      fbx_telegraf false</span> <br />
  &gt;</p>
  </blockquote>
  <p class="Style3"> On redemarre le docker influxdb pour prise en compte.</p>
</blockquote>
<p class="Style5">Autorisation de l'application sur le Freebox.</p>
<blockquote>
      <p> <span class="Style3">il faut autoriser l'application sur la Freebox.<br />
      Pour cela : 
      se placer dans une console fbx_telegraf et aller dans le dossier </span><span class="Style4">/usr/local/py</span></p>
      <blockquote>
        <p><span class="Style4">root@fbx_telegraf:/usr/local/py# <strong>python3 freebox_050.py -r</strong></span></p>
      </blockquote>
  <p class="Style3"><span class="Style6">Il faut valider sur l'ecran LCD de la Freebox.</span><br />
   Le nom de l'application codée dans le fichier fbx_telegraf_050.py est : <strong>grafanamonitor.</strong></p>
  <p class="Style3">    Controler sur la Freebox que l'application a bien été acceptée : </p>
  <blockquote>
    <p class="Style3"> Paramètres / Gestion des Accès / Applications</p>
  </blockquote>
</blockquote>
<p align="center" class="Style3"><img src="fbx gestion acces.PNG" width="900" height="358" /></p>
<blockquote>
  <p class="Style3"> On peut aussi vérifier sur la console fbx_telegraf : </p>
  <blockquote>
    <p class="Style3">    <span class="Style4">root@fbx_telegraf:/usr/local/py# <strong>python3 freebox_050.py -s</strong> <br />
      </span><span class="Style10">Status: auth already done </span><span class="Style4"><br />
      root@fbx_telegraf:/usr/local/py#</span></p>
    <p class="Style3"><span class="Style4">
      root@fbx_telegraf:/usr/local/py# <strong>python3 freebox_050.py -r</strong> <br />
      </span><span class="Style10">Already registered, exiting </span><span class="Style4"><br />
      root@fbx_telegraf:/usr/local/py#</span></p>
  </blockquote>
  <p class="Style3"> Vous trouverez alors un fichiers .credentials dans le répertoire /usr/local/py du docker fbx_telegraf</p>
</blockquote>
<p> <span class="Style3"><strong>A partir de là, fbx_telegraf est en mesure de collecter les données sur la Freebox, et de les envoyer sur la base de données fbx_telegraf du docker influxdb</strong>.</span></p>
<blockquote>
  <p class="Style3"> on peut contrôler à la main que les valeurs sont bien accessibles, par exemple : </p>
  <blockquote>
    <p class="Style4"> root@fbx_telegraf:/usr/local/py# <strong>python3 freebox_050.py -H | grep System </strong><br />
      <span class="Style8">freebox,endpoint=mafreebox.freebox.fr,tag1=System,tag2=NULL,tag3=NULL sys_temp_cpum=64<br />
      freebox,endpoint=mafreebox.freebox.fr,tag1=System,tag2=NULL,tag3=NULL sys_temp_sw=54 <br />
      freebox,endpoint=mafreebox.freebox.fr,tag1=System,tag2=NULL,tag3=NULL sys_uptime_val=2478544<br />
      freebox,endpoint=mafreebox.freebox.fr,tag1=System,tag2=NULL,tag3=NULL uptime=&quot;28 jours 16 heures 29 minutes 4 secondes&quot; <br />
      freebox,endpoint=mafreebox.freebox.fr,tag1=System,tag2=NULL,tag3=NULL firmware_version=&quot;4.0.7&quot; <br />
      freebox,endpoint=mafreebox.freebox.fr,tag1=System,tag2=NULL,tag3=NULL sys_fan_rpm=2313 <br />
      freebox,endpoint=mafreebox.freebox.fr,tag1=System,tag2=NULL,tag3=NULL sys_temp_cpub=67 </span><br />
    root@fbx_telegraf:/usr/local/py# </p>
  </blockquote>
  <p class="Style3"> Dans la console du docker influxdb, on verifie que l'on recoit bien les données de nas_telegraf et fbx_telegraf</p>
</blockquote>
<p align="center" class="Style3"><img src="console influxdb.JPG" width="900" height="323" /></p>
<p><span class="Style5">Grafana :</span></p>
<blockquote>
  <p>
 S<span class="Style3">ur grafana, definir une nouvelle source de données : </span></p>
  <table width="75%" border="1" cellspacing="2" bordercolor="#0000FF">
    <tr>
      <td><span class="Style3">Name</span></td>
      <td><span class="Style3">InfluxDB-1 Freebox</span></td>
      <td><span class="Style3">par example</span></td>
    </tr>
    <tr>
      <td><span class="Style3">URL</span></td>
      <td><span class="Style3"> http://@NAS:8086</span></td>
      <td><span class="Style3">comme pour  nas_telegraf, car c'est le même docker influxdb</span></td>
    </tr>
    <tr>
      <td><span class="Style3">Access</span></td>
      <td><span class="Style3">serveur</span></td>
      <td>&nbsp;</td>
    </tr>
    <tr>
      <td><span class="Style3">Basic auth</span></td>
      <td><span class="Style3">yes</span></td>
      <td>&nbsp;</td>
    </tr>
    <tr>
      <td><span class="Style3">Basic auth details</span></td>
      <td>&nbsp;</td>
      <td>&nbsp;</td>
    </tr>
    <tr>
      <td><div align="right">
        <blockquote>
          <p><span class="Style3">user</span></p>
        </blockquote>
      </div></td>
      <td><span class="Style3">fbx_telegraf</span></td>
      <td>&nbsp;</td>
    </tr>
    <tr>
      <td><div align="right">
        <blockquote>
          <p><span class="Style3">password</span></p>
        </blockquote>
      </div></td>
      <td><span class="Style3">fbx_telegraf</span></td>
      <td>&nbsp;</td>
    </tr>
    <tr>
      <td><span class="Style3">Database</span></td>
      <td><span class="Style3">fbx_telegraf</span></td>
      <td>&nbsp;</td>
    </tr>
    <tr>
      <td><div align="right">
        <blockquote>
          <p><span class="Style3">User</span></p>
        </blockquote>
      </div></td>
      <td><span class="Style3">fbx_telegraf</span></td>
      <td>&nbsp;</td>
    </tr>
    <tr>
      <td><div align="right">
        <blockquote>
          <p><span class="Style3">password</span></p>
        </blockquote>
      </div></td>
      <td><span class="Style3">fbx_telegraf</span></td>
      <td>&nbsp;</td>
    </tr>
    <tr>
      <td><p><span class="Style3">http method</span></p></td>
      <td><span class="Style3">GET</span></td>
      <td>&nbsp;</td>
    </tr>
  </table>
  <p>On valide (SAVE &amp; TEST) et ce doit être OK.</p>
</blockquote>
<p class="Style3"> Il ne reste plus qu'à créer le ou les Dashboard souhaités ! 
  =&gt; Ne pas oublier de préciser l'origine des données : InfluxDB-1 Freebox</p>
<p class="Style3"> Pour ma part, j'ai réalisé :</p>
<ul>
  <li> un Dashboard général (trafic, CPU, status des ports du switch, températures ....)</li>
  <li> un Dashboard listant les stations actives (globales et Wifi)</li>
</ul>
<p align="center"><img src="fbox.jpg" width="900" height="564" /></p>
<p align="center"><img src="stations fbx.PNG" width="900" height="426" /></p>
<p class="Style3"> Je peux partager les fichiers de configurations des dashboards (json) si vous le souhaitez.<br />
    <br />
    <strong>Resterait à faire :</strong> l'API de la Freebox est accessible ici en http. Je n'ai pas réussi par manque de connaissances à passer en https. Si quelqu'un veut s'atteler au sujet ...</p>
<p> <br />
    <br />
</p>
</body>

</html>
